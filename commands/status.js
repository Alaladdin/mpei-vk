const fetch = require('node-fetch');
const { version } = require('../package.json');
const {
  serverAddress,
  prefix,
  mailSchedule,
  mailParserEnabled,
  isProd,
} = require('../config');

module.exports = {
  name: 'status',
  description: '胁芯写懈 懈薪芯屑邪懈 芯 斜芯械',
  aliases: ['info', 'i'],
  async execute(ctx) {
    const msg = [];
    const serverData = (query) => fetch(`${serverAddress}/${query}`)
      .then(async (res) => {
        const json = await res.json();

        if (!res.ok) throw new Error(res.statusText);

        return Object.values(json)[0];
      })
      .catch((err) => {
        console.error(err);
        return 'error';
      });

    const serverHealth = await serverData('health');

    // bot info
    msg.push('- Bot info');
    msg.push(`路 version: ${version}`);
    msg.push(`路 prefix: "${!Array.isArray(prefix) ? prefix : prefix.join(', ')}"`);
    msg.push(`路 isProduction: ${isProd}`);
    msg.push(`路 mailListen: ${mailParserEnabled}`);
    msg.push(`路 mailListen time: "${mailSchedule}"`);

    // server info
    msg.push('\n- Server info');
    msg.push(`路 address: ${serverAddress}`);
    msg.push(`路 version: ${await serverData('version')}`);
    msg.push(`路 health: ${serverHealth !== 'error' ? '' : serverHealth}`);
    msg.push(`路 ping: ${await serverData('ping')}`);

    ctx.send(msg.join('\n'), {
      dont_parse_links: true,
    });
  },
};
